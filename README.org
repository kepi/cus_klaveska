* Kepiho ČUS kláveska
[2017-03-04 So 00:34]

Klávesnice se chová ve většině ohledů jako standardní US QWERTY klávesnice, ale umožňuje nám psát české znaky bez přepínání klávesnice. Konkrétně rozdíly:

[[./preview/cust_cz_us-0.png]]

- na vrchní řadě nepíšeme čísla, ale klasické české ěščř...
- čísla píšeme s pravým Alt
- znaky =ů= je vlevo vedle =ě= a =+= ještě o jeden vedle.

Zásadní výhoda je, že klávesnice zůstává stejná s jedinou výjimkou čísel při použití pravého altu. Všechny znaky můžete napsat s jediným layoutem.

Celý layout lze prohlédnout v [[./preview/cust_cz_us.pdf][PDF s layoutem.]]

** Přidání keyboard layoutu
Nastavení keyboard layoutu je třeba umístit do souboru [[/usr/share/X11/xkb/symbols/cust_cz_us]]

#+BEGIN_SRC 

default
xkb_symbols "basic" {
    include "us(basic)"

    name[Group1]="Czech (custom US)";

    key <TLDE>	{ [     equal,           plus,  asciitilde,             grave]	};
    key <AE01>	{ [     uring,         exclam,           1,        dead_tilde],
		  [         1,         exclam,           1,        dead_tilde]};
    key <AE02>	{ [    ecaron,             at,           2,        dead_caron],
		  [         2,             at,           2,        dead_caron]};
    key <AE03>	{ [    scaron,     numbersign,           3,   dead_circumflex],
                  [         3,     numbersign,           3,   dead_circumflex]};
    key <AE04>	{ [    ccaron,         dollar,           4,        dead_breve],
                  [         4,         dollar,           4,        dead_breve]};
    key <AE05>	{ [    rcaron,        percent,           5,    dead_abovering],
                  [         5,        percent,           5,    dead_abovering]};
    key <AE06>	{ [    zcaron,    asciicircum,           6,       dead_ogonek],
                  [         6,    asciicircum,           6,       dead_ogonek]};
    key <AE07>	{ [    yacute,      ampersand,           7,        dead_grave],
                  [         7,      ampersand,           7,        dead_grave]};
    key <AE08>	{ [    aacute,       asterisk,           8,      dead_abovedot],
                  [         8,       asterisk,           8,      dead_abovedot]};
    key <AE09>	{ [    iacute,      parenleft,           9,        dead_acute],
                  [         9,      parenleft,           9,        dead_acute]};
    key <AE10>	{ [    eacute,     parenright,           0,  dead_doubleacute],
                  [         0,     parenright,           0,  dead_doubleacute]};
    key <AE12>	{ [dead_acute,     dead_caron, dead_macron,      dead_cedilla]};

    key <AC10>	{ [ semicolon,            colon,     uring,          NoSymbol ]	};
    key <AC11>	{ [apostrophe,        quotedbl,   section,            ssharp ]	};

//    key <CAPS> { [ ISO_Level5_Shift , BackSpace , Caps_Lock , Caps_Lock , NoSymbol ] };
//   modifier_map Mod3   { ISO_Level5_Shift };

//    include "capslock(grouplock)"
    
    replace key <CAPS> {	[	ISO_Next_Group, Caps_Lock		]	};
    modifier_map Lock { Caps_Lock };

    include "level3(ralt_switch)"
    // include "level5(caps_switch)"
};

#+END_SRC

Dále je třeba nastavit, aby se tato konfigurace použila. XKB Options použijeme k nastavení =Ctrl= namísto =Caps Lock=

** Nastavení keyboard layoutu
Nastavení klávesnice v debianu standardně v [[/etc/default/keyboard]]

#+BEGIN_SRC  sh
# KEYBOARD CONFIGURATION FILE

# Consult the keyboard(5) manual page.

XKBMODEL="pc105"
XKBLAYOUT="cust_cz_us"
XKBVARIANT=""
XKBOPTIONS="ralt_switch,terminate:ctrl_alt_bksp,grp_led:scroll,ctrl:nocaps"
BACKSPACE="guess"
#+END_SRC

** Úprava chování Caps Locku
A protože je mi to málo, nastavím ještě lepší chování =Caps Lock= kdy při zmáčknutí se chová jako =Esc= a při podržení jako =Ctrl=

#+BEGIN_SRC sh
xcape -e 'Control_L=Escape'
#+END_SRC

Nevím jestli je třeba, ale mám to v autostart souboru nastavené historicky takto (zdá se mi, že se duplikuje konfigurace z keyboard)

#+BEGIN_SRC sh
setxkbmap cust_cz_us -option ralt_switch,terminate:ctrl_alt_bksp,grp_led:scroll,ctrl:nocaps && xcape -e 'Control_L=Escape'
#+END_SRC

** Vygenerování aktuálního layoutu do PDF

Tohle není třeba nijak řešit, ale pokud uděláme změny v layoutu, můžeme si chtít refreshnout obrázky.

Aby to šlo pěkně i českými znaky, je třeba pořídit patchnutý program *ogonkify*. Postup je následující:

#+BEGIN_SRC bash
[[ -f /usr/bin/ogonkify ]] || sudo apt-get install a2ps
[[ -f tools/ogonkify ]] || (cd tools && cp /usr/bin/ogonkify ./ && patch -p0 < ogonkify.patch)
#+END_SRC

Následně už můžeme spustit vygenerování PDF:

#+BEGIN_SRC sh :results none
setxkbmap -layout cust_cz_us  -print | xkbcomp -xkm - - | xkbprint -color -lc cs_CZ -npk 1 - - | ./tools/ogonkify -XP | ps2pdf - | pdftk - cat 1-endwest output preview/cust_cz_us.pdf
convert -trim -density 100 preview/cust_cz_us.pdf -quality 100 preview/cust_cz_us.png
#+END_SRC
